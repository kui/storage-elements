(function(e){function h(n){if(i[n])return i[n].exports;var o=i[n]={exports:{},id:n,loaded:!1};return e[n].call(o.exports,o,o.exports,h),o.loaded=!0,o.exports}var i={};return h.m=e,h.c=i,h.p="",h(0)})([function(e,h,i){"use strict";var n=i(2),o=function(x){return x&&x.__esModule?x:{default:x}}(n),p=i(1),t=function(x){if(x&&x.__esModule)return x;var y={};if(null!=x)for(var z in x)Object.prototype.hasOwnProperty.call(x,z)&&(y[z]=x[z]);return y.default=x,y}(p);localStorage&&t.registerHandler("local-storage",new t.WebStorageAreaHandler(localStorage)),sessionStorage&&t.registerHandler("session-storage",new t.WebStorageAreaHandler(sessionStorage)),chrome&&chrome.storage&&(chrome.storage.local&&t.registerHandler("chrome-local",new t.ChromeStorageAreaHandler(chrome.storage.local)),chrome.storage.sync&&t.registerHandler("chrome-sync",new t.ChromeStorageAreaHandler(chrome.storage.sync))),Object.defineProperty(o.default,"extends",{get:()=>"form"}),document.registerElement("storage-form",o.default)},function(e,h){"use strict";h.__esModule=!0,h.registerHandler=function(o,p){if(i[o])throw Error(`Already registered handler for "${o}"`);i[o]=p},h.findHandler=function(o){return i[o]};var i={};h.WebStorageAreaHandler=class{constructor(o){this.storage=o}read(o){return Promise.resolve(this.storage.getItem(o))}write(o,p){return this.storage.setItem(o,p),Promise.resolve()}removeItem(o){return this.storage.removeItem(o),Promise.resolve()}},h.ChromeStorageAreaHandler=class{constructor(o){this.storage=o}read(o){return new Promise(p=>this.storage.get(o,t=>p(t[o])))}write(o,p){return new Promise(t=>this.storage.set({[o]:p},t))}removeItem(o){return new Promise(p=>this.storage.remove(o,p))}}},function(e,h,i){"use strict";function n(E){if(E&&E.__esModule)return E;var F={};if(null!=E)for(var G in E)Object.prototype.hasOwnProperty.call(E,G)&&(F[G]=E[G]);return F.default=E,F}function o(E){return function(){var F=E.apply(this,arguments);return new Promise(function(G,H){function I(J,K){try{var L=F[J](K),M=L.value}catch(N){return void H(N)}return L.done?void G(M):Promise.resolve(M).then(function(N){I("next",N)},function(N){I("throw",N)})}return I("next")})}}function p(E,F){if(E.size!==F.size)return!1;for(var G=E,H=Array.isArray(G),I=0,G=H?G:G[Symbol.iterator]();;){var J;if(H){if(I>=G.length)break;J=G[I++]}else{if(I=G.next(),I.done)break;J=I.value}var K=J;if(!F.has(K))return!1}for(var L=F,M=Array.isArray(L),N=0,L=M?L:L[Symbol.iterator]();;){var O;if(M){if(N>=L.length)break;O=L[N++]}else{if(N=L.next(),N.done)break;O=N.value}var P=O;if(!E.has(P))return!1}return!0}function t(E){return new Set(v(E,F=>F.name))}function v(E,F,G){return Array.from(E).map(F,G)}function x(E,F){var G=E.getAttribute(F);return G?G:""}function y(E,F,G){null==G||E.setAttribute(F,G)}h.__esModule=!0;var z=i(3),A=n(z),B=i(1),C=n(B);class D extends HTMLFormElement{get autosync(){var E=parseInt(x(this,"autosync"));return 0<E?E:500}set autosync(E){y(this,"autosync",E)}get area(){return x(this,"area")}set area(E){y(this,"area",E)}constructor(){super()}createdCallback(){this.values={},this.formElements=new A.MultiValueMap,this.scanIntervalMillis=700,this.componentObservers=new Map,this.syncPromise=null,this.addEventListener("submit",E=>{E.preventDefault(),this.sync(null,{noLoad:!0})}),new MutationObserver(()=>{console.debug("scan by form MutationObserver: ",this),this.scanComponents()}).observe(this,{childList:!0,subtree:!0}),this.scanComponents(),this.isAutoSyncEnabled()&&this.startPeriodicalSync()}attachedCallback(){this.scanComponents(),this.isAutoSyncEnabled()&&this.startPeriodicalSync()}detachedCallback(){null!=this.storageSyncTask&&clearTimeout(this.storageSyncTask),this.stopPeriodicalScan()}startPeriodicalScan(){var E=this;return o(function*(){if(null==E.scanTask)for(;;)E.scanTask=A.sleep(E.scanIntervalMillis),yield E.scanTask,yield E.scanComponents()})()}stopPeriodicalScan(){null==this.scanTask||(this.scanTask.cancell(),this.scanTask=null)}startPeriodicalSync(){var E=this;return o(function*(){if(null==E.syncTask)for(;;)E.syncTask=A.sleep(E.autosync),yield E.syncTask,yield E.sync()})()}stopPeriodicalSync(){null==this.syncTask||(this.syncTask.cancell(),this.syncTask=null)}scanComponents(){var E=this;return o(function*(){E.syncPromise&&(yield E.syncPromise);var F=E.getFormElementSet(),G=E.getCurrentElements(),H=new Set(Object.keys(E.values)),I=t(G),J=[];if(!(p(H,I)&&p(F,G))){E.formElements=Array.from(G).reduce(function(Y,Z){return Y.add(Z.name,Z),Y},new A.MultiValueMap);var K=A.subtractSet(G,F);0<K.size&&K.forEach(E.afterComponentAppend,E);var L=A.subtractSet(I,H);Array.from(K).map(function(Y){return Y.name}).forEach(L.add,L),0<L.size&&J.push(E.sync(Array.from(L)));var M=A.subtractSet(F,G);0<M.size&&M.forEach(E.afterComponentRemove,E);var N=A.subtractSet(H,I);if(0<N.size)for(var O=N,P=Array.isArray(O),Q=0,O=P?O:O[Symbol.iterator]();;){var R;if(P){if(Q>=O.length)break;R=O[Q++]}else{if(Q=O.next(),Q.done)break;R=Q.value}var S=R;console.debug("Removed name: %o",S),delete E.values[S]}for(var T=J,U=Array.isArray(T),V=0,T=U?T:T[Symbol.iterator]();;){var W;if(U){if(V>=T.length)break;W=T[V++]}else{if(V=T.next(),V.done)break;W=V.value}var X=W;yield X}}})()}getCurrentElements(){return new Set(Array.from(this.elements).filter(E=>E.name))}getFormElementSet(){return Array.from(this.formElements.values()).reduce((E,F)=>{return F.forEach(E.add,E),E},new Set)}afterComponentAppend(E){console.debug("afterComponentAppend: %o",E);var F=new MutationObserver(()=>{console.debug("scan by \"name\" atter MutationObserver: ",E),this.scanComponents()});F.observe(E,{attributes:!0,attributeFilter:["name"]}),this.componentObservers.set(E,F)}afterComponentRemove(E){console.debug("afterComponentRemove: %o",E);var F=this.componentObservers.get(E);F&&F.disconnect()}load(E){var F=this;return o(function*(){var G=yield F.readStorageAll(),H=F.diffValues(G,F.values);if(E||(E=Object.keys(H)),0!==E.length){var I={};for(var J=E,K=Array.isArray(J),L=0,J=K?J:J[Symbol.iterator]();;){var M;if(K){if(L>=J.length)break;M=J[L++]}else{if(L=J.next(),L.done)break;M=L.value}var N=M;F.values[N]=G[N],I[N]=H[N]||[]}F.writeForm(I)}})()}store(E){var F=this;return o(function*(){var G=F.readFormAll(),H=F.diffValues(G,F.values);if(E||(E=Object.keys(H)),0!==E.length){var I={};for(var J=E,K=Array.isArray(J),L=0,J=K?J:J[Symbol.iterator]();;){var M;if(K){if(L>=J.length)break;M=J[L++]}else{if(L=J.next(),L.done)break;M=L.value}var N=M;F.values[N]=G[N],I[N]=H[N]||[]}yield F.writeStorage(I)}})()}diffValues(E,F){var G=A.dedup(Object.keys(E).concat(Object.keys(F)));return G.reduce((H,I)=>{null==E[I]&&(E[I]=[]),null==F[I]&&(F[I]=[]);var J=[],K=Math.max(E[I].length,F[I].length);for(var L=0;L<K;L++){var M=E[I][L],N=F[I][L];J[L]=M===N?null:[M,N]}return J.some(O=>null!==O)&&(H[I]=J),H},{})}readStorageAll(){var E=this;return o(function*(){var F=Array.from(E.formElements.flattenValues()).reduce(function(O,P){var Q=P.name;return O[Q]=E.readStorageByName(Q),O},{}),G={};for(var H=Object.entries(F),I=Array.isArray(H),J=0,H=I?H:H[Symbol.iterator]();;){var K;if(I){if(J>=H.length)break;K=H[J++]}else{if(J=H.next(),J.done)break;K=J.value}var L=K,M=L[0],N=L[1];G[M]=yield N}return G})()}readStorageByName(E){var F=this;return o(function*(){var G=yield F.getAreaHandler().read(E);return null==G?[]:[G]})()}writeForm(E){var F=this,G=function(P,Q){var R=Q[0],S=null==R?[]:R,T=S[0],U=F.formElements.get(P);null==U||(console.debug("write to form: name=%s, value=%s, elements=%o",P,T,U),U.forEach(V=>{return"checkbox"===V.type||"radio"===V.type?void(V.checked=T===V.value):null==V.value?void console.error("Unsupported element: %o",V):null==T?void 0:void(V.value=T)}))};for(var H=Object.entries(E),I=Array.isArray(H),J=0,H=I?H:H[Symbol.iterator]();;){var K;if(I){if(J>=H.length)break;K=H[J++]}else{if(J=H.next(),J.done)break;K=J.value}var L=K,M=L[0],N=L[1];G(M,N)}}writeStorage(E){var F=this;return o(function*(){var G=F.getAreaHandler(),H=Object.entries(E).map((()=>{var I=o(function*(J){var K=J[0],L=J[1],M=L[0];if(null!=M){var N=M[0];null==N?(console.debug("remove from storage: name=%o",K),yield G.removeItem(K)):(console.debug("write to storage: name=%o, value=%o",K,N),yield G.write(K,N))}});return function(){return I.apply(this,arguments)}})());yield Promise.all(H)})()}readFormAll(){return Array.from(this.formElements.flattenValues()).reduce((E,F)=>{if(null==F.value)return E;var G=F.name;if(null==E[G]&&(E[G]=[]),"checkbox"===F.type||"radio"===F.type)return F.checked&&E[G].push(F.value),E;if(null!=F.options){for(var H=F.options,I=Array.isArray(H),J=0,H=I?H:H[Symbol.iterator]();;){var K;if(I){if(J>=H.length)break;K=H[J++]}else{if(J=H.next(),J.done)break;K=J.value}var L=K;L.selected&&E[G].push(L.value)}return E}return E[G].push(F.value),E},{})}getAreaHandler(){var E=this.getArea();if(!E)throw Error("\"area\" attribute is required");var F=C.findHandler(E);if(!F)throw Error(`Unsupported area: "${E}"`);return F}getArea(){var E=this.getAttribute("area");return E?E:null}sync(E){var F=arguments,G=this;return o(function*(){var H=1<F.length&&void 0!==F[1]?F[1]:{noLoad:!1};G.syncPromise&&(yield G.syncPromise),G.syncPromise=o(function*(){H.noLoad||(yield G.load(E)),yield G.store(E),G.syncPromise=null})()})()}isAutoSyncEnabled(){return this.hasAttribute("autosync")}static get observedAttributes(){return["autosync","area"]}attributeChangedCallback(E){"autosync"===E?this.isAutoSyncEnabled()?this.startPeriodicalSync():this.stopPeriodicalSync():"area"===E?(this.values={},this.formElements=new A.MultiValueMap):void 0}}h.default=D},function(e,h){"use strict";h.__esModule=!0,h.sleep=function(p){var t=void 0;return new i(v=>{t=setTimeout(()=>v(),p)},()=>{clearTimeout(t)})},h.dedup=function(p){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:(v,x)=>v===x;return p.reduce((v,x)=>{if(v.some(y=>t(y,x)));return v.concat(x)},[])},h.subtractSet=function(p,t){return new Set(Array.from(p).filter(v=>!t.has(v)))};class i extends Promise{constructor(o,p){super(o),this.cancellFunction=p}cancell(){this.cancellFunction()}}h.CancellablePromise=i;class n extends Map{add(o,p){var t=this.get(o);return t||(t=[],this.set(o,t)),t.push(p),this}*flattenValues(){for(var o=this.values(),p=Array.isArray(o),t=0,o=p?o:o[Symbol.iterator]();;){var v;if(p){if(t>=o.length)break;v=o[t++]}else{if(t=o.next(),t.done)break;v=t.value}var x=v;for(var y=x,z=Array.isArray(y),A=0,y=z?y:y[Symbol.iterator]();;){var B;if(z){if(A>=y.length)break;B=y[A++]}else{if(A=y.next(),A.done)break;B=A.value}var C=B;yield C}}}}h.MultiValueMap=n}]);
//# sourceMappingURL=storage-elements.js.map