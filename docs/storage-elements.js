(function(e){function h(n){if(i[n])return i[n].exports;var o=i[n]={exports:{},id:n,loaded:!1};return e[n].call(o.exports,o,o.exports,h),o.loaded=!0,o.exports}var i={};return h.m=e,h.c=i,h.p="",h(0)})([function(e,h,i){"use strict";var n=i(2),o=function(x){return x&&x.__esModule?x:{default:x}}(n),p=i(1),t=function(x){if(x&&x.__esModule)return x;var y={};if(null!=x)for(var z in x)Object.prototype.hasOwnProperty.call(x,z)&&(y[z]=x[z]);return y.default=x,y}(p);localStorage&&t.registerHandler("local-storage",new t.WebStorageAreaHandler(localStorage)),sessionStorage&&t.registerHandler("session-storage",new t.WebStorageAreaHandler(sessionStorage)),chrome&&chrome.storage&&(chrome.storage.local&&t.registerHandler("chrome-local",new t.ChromeStorageAreaHandler(chrome.storage.local)),chrome.storage.sync&&t.registerHandler("chrome-sync",new t.ChromeStorageAreaHandler(chrome.storage.sync))),Object.defineProperty(o.default,"extends",{get:()=>"form"}),document.registerElement("storage-form",o.default)},function(e,h){"use strict";h.__esModule=!0,h.registerHandler=function(o,p){if(i[o])throw Error(`Already registered handler for "${o}"`);i[o]=p},h.findHandler=function(o){return i[o]};var i={};h.WebStorageAreaHandler=class{constructor(o){this.storage=o}read(o){return Promise.resolve(this.storage.getItem(o))}write(o,p){return this.storage.setItem(o,p),Promise.resolve()}removeItem(o){return this.storage.removeItem(o),Promise.resolve()}},h.ChromeStorageAreaHandler=class{constructor(o){this.storage=o}read(o){return new Promise(p=>this.storage.get(o,t=>p(t[o])))}write(o,p){return new Promise(t=>this.storage.set({[o]:p},t))}removeItem(o){return new Promise(p=>this.storage.remove(o,p))}}},function(e,h,i){"use strict";function n(D){if(D&&D.__esModule)return D;var E={};if(null!=D)for(var F in D)Object.prototype.hasOwnProperty.call(D,F)&&(E[F]=D[F]);return E.default=D,E}function o(D){return function(){var E=D.apply(this,arguments);return new Promise(function(F,G){function H(I,J){try{var K=E[I](J),L=K.value}catch(M){return void G(M)}return K.done?void F(L):Promise.resolve(L).then(function(M){H("next",M)},function(M){H("throw",M)})}return H("next")})}}function p(D,E){if(D.size!==E.size)return!1;for(var F=D,G=Array.isArray(F),H=0,F=G?F:F[Symbol.iterator]();;){var I;if(G){if(H>=F.length)break;I=F[H++]}else{if(H=F.next(),H.done)break;I=H.value}var J=I;if(!E.has(J))return!1}for(var K=E,L=Array.isArray(K),M=0,K=L?K:K[Symbol.iterator]();;){var N;if(L){if(M>=K.length)break;N=K[M++]}else{if(M=K.next(),M.done)break;N=M.value}var O=N;if(!D.has(O))return!1}return!0}function t(D){return new Set(function*(){for(var E=D,F=Array.isArray(E),G=0,E=F?E:E[Symbol.iterator]();;){var H;if(F){if(G>=E.length)break;H=E[G++]}else{if(G=E.next(),G.done)break;H=G.value}var I=H;yield I.name}}())}function v(D,E){var F=D.getAttribute(E);return F?F:""}function x(D,E,F){null==F||D.setAttribute(E,F)}h.__esModule=!0;var y=i(3),z=n(y),A=i(1),B=n(A);class C extends HTMLFormElement{get autosync(){var D=parseInt(v(this,"autosync"));return 0<D?D:500}set autosync(D){x(this,"autosync",D)}get area(){return v(this,"area")}set area(D){x(this,"area",D)}constructor(){super()}createdCallback(){this.values={},this.formElements=new z.ArrayValueMap,this.scanIntervalMillis=700,this.componentObservers=new Map,this.syncPromise=null,this.addEventListener("submit",D=>{D.preventDefault(),this.sync(null,{noLoad:!0})}),new MutationObserver(()=>{console.debug("scan by form MutationObserver: ",this),this.scanComponents()}).observe(this,{childList:!0,subtree:!0}),this.scanComponents(),this.isAutoSyncEnabled()&&this.startPeriodicalSync()}attachedCallback(){this.scanComponents(),this.isAutoSyncEnabled()&&this.startPeriodicalSync()}detachedCallback(){null!=this.storageSyncTask&&clearTimeout(this.storageSyncTask),this.stopPeriodicalScan()}startPeriodicalScan(){var D=this;return o(function*(){if(null==D.scanTask)for(;;)D.scanTask=z.sleep(D.scanIntervalMillis),yield D.scanTask,yield D.scanComponents()})()}stopPeriodicalScan(){null==this.scanTask||(this.scanTask.cancell(),this.scanTask=null)}startPeriodicalSync(){var D=this;return o(function*(){if(null==D.syncTask)for(;;)D.syncTask=z.sleep(D.autosync),yield D.syncTask,yield D.sync()})()}stopPeriodicalSync(){null==this.syncTask||(this.syncTask.cancell(),this.syncTask=null)}scanComponents(){var D=this;return o(function*(){for(;D.syncPromise;)yield D.syncPromise;var E=D.getFormElementSet(),F=D.getCurrentElements(),G=new Set(Object.keys(D.values)),H=t(F),I=[];if(!(p(G,H)&&p(E,F))){D.formElements=Array.from(F).reduce(function(X,Y){return X.add(Y.name,Y),X},new z.ArrayValueMap);var J=z.subtractSet(F,E);0<J.size&&J.forEach(D.afterComponentAppend,D);var K=z.subtractSet(H,G);Array.from(J).map(function(X){return X.name}).forEach(K.add,K),0<K.size&&I.push(D.sync(Array.from(K)));var L=z.subtractSet(E,F);0<L.size&&L.forEach(D.afterComponentRemove,D);var M=z.subtractSet(G,H);if(0<M.size)for(var N=M,O=Array.isArray(N),P=0,N=O?N:N[Symbol.iterator]();;){var Q;if(O){if(P>=N.length)break;Q=N[P++]}else{if(P=N.next(),P.done)break;Q=P.value}var R=Q;console.debug("Removed name: %o",R),delete D.values[R]}for(var S=I,T=Array.isArray(S),U=0,S=T?S:S[Symbol.iterator]();;){var V;if(T){if(U>=S.length)break;V=S[U++]}else{if(U=S.next(),U.done)break;V=U.value}var W=V;yield W}}})()}getCurrentElements(){var D=this.elements;return new Set(function*(){for(var E=D,F=Array.isArray(E),G=0,E=F?E:E[Symbol.iterator]();;){var H;if(F){if(G>=E.length)break;H=E[G++]}else{if(G=E.next(),G.done)break;H=G.value}var I=H;I.name&&(yield I)}}())}getFormElementSet(){return new Set(this.formElements.flattenValues())}afterComponentAppend(D){console.debug("afterComponentAppend: %o",D);var E=new MutationObserver(()=>{console.debug("scan by \"name\" atter MutationObserver: ",D),this.scanComponents()});E.observe(D,{attributes:!0,attributeFilter:["name"]}),this.componentObservers.set(D,E)}afterComponentRemove(D){console.debug("afterComponentRemove: %o",D);var E=this.componentObservers.get(D);E&&E.disconnect()}load(D){var E=this;return o(function*(){var F=yield E.readStorageAll(),G=E.diffValues(F,E.values);if(D||(D=Object.keys(G)),0!==D.length){var H={};for(var I=D,J=Array.isArray(I),K=0,I=J?I:I[Symbol.iterator]();;){var L;if(J){if(K>=I.length)break;L=I[K++]}else{if(K=I.next(),K.done)break;L=K.value}var M=L;E.values[M]=F[M],H[M]=G[M]||[]}E.writeForm(H)}})()}store(D){var E=this;return o(function*(){var F=E.readFormAll(),G=E.diffValues(F,E.values);if(D||(D=Object.keys(G)),0!==D.length){var H={};for(var I=D,J=Array.isArray(I),K=0,I=J?I:I[Symbol.iterator]();;){var L;if(J){if(K>=I.length)break;L=I[K++]}else{if(K=I.next(),K.done)break;L=K.value}var M=L;E.values[M]=F[M],H[M]=G[M]||[]}yield E.writeStorage(H)}})()}diffValues(D,E){var F=z.dedup(Object.keys(D).concat(Object.keys(E)));return F.reduce((G,H)=>{null==D[H]&&(D[H]=[]),null==E[H]&&(E[H]=[]);var I=[],J=Math.max(D[H].length,E[H].length);for(var K=0;K<J;K++){var L=D[H][K],M=E[H][K];I[K]=L===M?null:[L,M]}return I.some(N=>null!==N)&&(G[H]=I),G},{})}readStorageAll(){var D=this;return o(function*(){var E=Array.from(D.formElements.flattenValues()).reduce(function(N,O){var P=O.name;return N[P]=D.readStorageByName(P),N},{}),F={};for(var G=Object.entries(E),H=Array.isArray(G),I=0,G=H?G:G[Symbol.iterator]();;){var J;if(H){if(I>=G.length)break;J=G[I++]}else{if(I=G.next(),I.done)break;J=I.value}var K=J,L=K[0],M=K[1];F[L]=yield M}return F})()}readStorageByName(D){var E=this;return o(function*(){var F=yield E.getAreaHandler().read(D);return null==F?[]:[F]})()}writeForm(D){var E=this,F=function(O,P){var Q=P[0],R=null==Q?[]:Q,S=R[0],T=E.formElements.get(O);null==T||(console.debug("write to form: name=%s, value=%s, elements=%o",O,S,T),T.forEach(U=>{return"checkbox"===U.type||"radio"===U.type?void(U.checked=S===U.value):null==U.value?void console.error("Unsupported element: %o",U):null==S?void 0:void(U.value=S)}))};for(var G=Object.entries(D),H=Array.isArray(G),I=0,G=H?G:G[Symbol.iterator]();;){var J;if(H){if(I>=G.length)break;J=G[I++]}else{if(I=G.next(),I.done)break;J=I.value}var K=J,L=K[0],M=K[1];F(L,M)}}writeStorage(D){var E=this;return o(function*(){var F=E.getAreaHandler(),G=Object.entries(D).map((()=>{var H=o(function*(I){var J=I[0],K=I[1],L=K[0];if(null!=L){var M=L[0];null==M?(console.debug("remove from storage: name=%o",J),yield F.removeItem(J)):(console.debug("write to storage: name=%o, value=%o",J,M),yield F.write(J,M))}});return function(){return H.apply(this,arguments)}})());yield Promise.all(G)})()}readFormAll(){return Array.from(this.formElements.flattenValues()).reduce((D,E)=>{if(null==E.value)return D;var F=E.name;if(null==D[F]&&(D[F]=[]),"checkbox"===E.type||"radio"===E.type)return E.checked&&D[F].push(E.value),D;if(null!=E.options){for(var G=E.options,H=Array.isArray(G),I=0,G=H?G:G[Symbol.iterator]();;){var J;if(H){if(I>=G.length)break;J=G[I++]}else{if(I=G.next(),I.done)break;J=I.value}var K=J;K.selected&&D[F].push(K.value)}return D}return D[F].push(E.value),D},{})}getAreaHandler(){var D=this.getArea();if(!D)throw Error("\"area\" attribute is required");var E=B.findHandler(D);if(!E)throw Error(`Unsupported area: "${D}"`);return E}getArea(){var D=this.getAttribute("area");return D?D:null}sync(D){var E=arguments,F=this;return o(function*(){for(1<E.length&&void 0!==E[1]?E[1]:{noLoad:!1};F.syncPromise;)yield F.syncPromise;F.syncPromise=o(function*(){f.noLoad||(yield F.load(D)),yield F.store(D),F.syncPromise=null})(),yield F.syncPromise})()}isAutoSyncEnabled(){return this.hasAttribute("autosync")}static get observedAttributes(){return["autosync","area"]}attributeChangedCallback(D){"autosync"===D?this.isAutoSyncEnabled()?this.startPeriodicalSync():this.stopPeriodicalSync():"area"===D?(this.values={},this.formElements=new z.ArrayValueMap):void 0}}h.default=C},function(e,h){"use strict";h.__esModule=!0,h.sleep=function(p){var t=void 0;return new i(v=>{t=setTimeout(()=>v(),p)},()=>{clearTimeout(t)})},h.dedup=function(p){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:(v,x)=>v===x;return p.reduce((v,x)=>{if(v.some(y=>t(y,x)));return v.concat(x)},[])},h.subtractSet=function(p,t){return new Set(Array.from(p).filter(v=>!t.has(v)))};class i extends Promise{constructor(o,p){super(o),this.cancellFunction=p}cancell(){this.cancellFunction()}}h.CancellablePromise=i;class n extends Map{*flattenValues(){for(var o=this.values(),p=Array.isArray(o),t=0,o=p?o:o[Symbol.iterator]();;){var v;if(p){if(t>=o.length)break;v=o[t++]}else{if(t=o.next(),t.done)break;v=t.value}var x=v;for(var y=x,z=Array.isArray(y),A=0,y=z?y:y[Symbol.iterator]();;){var B;if(z){if(A>=y.length)break;B=y[A++]}else{if(A=y.next(),A.done)break;B=A.value}var C=B;yield C}}}}h.ArrayValueMap=class extends n{add(p,t){var v=this.get(p);return v||(v=[],this.set(p,v)),v.push(t),this}},h.SetValueMap=class extends n{add(p,t){var v=this.get(p);return v||(v=new Set,this.set(p,v)),v.add(t),this}}}]);
//# sourceMappingURL=storage-elements.js.map